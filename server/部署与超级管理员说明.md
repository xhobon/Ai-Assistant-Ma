# 部署与超级管理员说明

## 当前状态总结

### 1. 超级管理员账号（已创建）

- **邮箱**: `your-email@example.com`
- **密码**: `YourSecurePassword`
- **名称**: 超级管理员  
- **ID**: `cmly1yr0n0000gopwv1zf34yx`

第二次执行时提示「超级管理员已存在」是正常的：脚本只允许存在一个超级管理员，不会重复创建。  
如需改用 `admin@ai-assistant.com`，可在数据库里把该用户的 email 改为 `admin@ai-assistant.com`，或删除当前超级管理员后重新运行脚本并设置新邮箱。

### 2. 关于 `cd server` 报错

当前目录已经是 `server` 时，再执行 `cd server` 会报错（因为不存在子目录 `server`）。  
在项目根目录时用一次 `cd server` 即可，之后命令直接执行，无需再写 `cd server`。

### 3. 部署地址说明

- **本次 CLI 部署的地址**: `https://traefmhs2e5i.vercel.app`  
  这里已经包含最新代码（数据持久化、管理员等）。
- **Mac 应用里配置的地址**: `https://ai-assistant-mac.vercel.app`  
  若该域名对应的是「通过 GitHub 关联的另一个 Vercel 项目」，则要确保那个项目也部署了最新代码（Root Directory = `server`，并重新部署）。

**二选一：**

- **方案 A**：继续用 `ai-assistant-mac.vercel.app`  
  - 在 Vercel 里打开「ai-assistant-mac」项目 → Settings → Git → 确认仓库与分支  
  - 确认 Root Directory 为 `server`，然后 Deployments 里触发一次 Redeploy（或推送代码触发部署）。  
  - Mac 应用无需改地址。

- **方案 B**：改用本次 CLI 部署的地址  
  - 在 Xcode 里打开 `AppServices.swift`  
  - 把 `builtInProductionURL` 改为：`https://traefmhs2e5i.vercel.app`  
  - 保存并重新编译运行 Mac 应用。

### 4. 助理长期记忆（自主学习）

- 后端新增 **UserMemory** 表与接口：`GET/POST /api/user/memory`、`DELETE /api/user/memory/:id`。
- 部署后需执行一次数据库迁移：在 `server` 目录下运行 `npx prisma migrate deploy`（或 `npx prisma db push`）以创建 `UserMemory` 表。
- 登录用户：对话时自动注入云端记忆，并在每轮回复后由 AI 提取新记忆写入用户数据；未登录用户：使用本地记忆作为上下文，可在「个人中心 → 助理记忆」中查看与编辑，登录后本地记忆会合并到云端。

### 5. 本机执行（OpenClaw / 内置命令执行）

- 后端对话接口支持 **`localExecution: true`**：助理可返回 `[CMD]命令[/CMD]`，由 Mac 应用在用户确认后执行（仅首页入口、白名单命令、结果发送前二次确认，保护隐私）。
- **需要重新部署后端** 才能生效；Mac 端需重新编译。

### 6. 登录与验证

1. 在 Mac 应用中打开「设置」→ 登录  
2. 使用上面超级管理员账号登录：`your-email@example.com` / `YourSecurePassword`  
3. 登录后对话与翻译会同步到云端；未登录时仍为本地保存。

**建议**：首次登录后尽快在应用内修改密码（若已有改密功能）。

---

## 何时需要重新部署

- **改动了 `server/` 下代码或 Prisma schema**（例如：新增接口、本机执行、助理记忆、管理员等）→ 需要 **重新部署后端**。
- **改动了 Mac 应用 Swift 代码**（例如：新功能、本机执行开关、修复崩溃等）→ 需要 **重新编译/打包 Mac 应用**。

---

## 完整部署流程与命令

### 一、后端（Vercel）重新部署

**方式 1：Git 推送触发（推荐）**

1. 在项目根目录打开终端，进入 server：
   ```bash
   cd /Users/akun/Desktop/Ai助理Mac/Ai助理Mac/server
   ```
2. 若修改了 Prisma schema（如新增 UserMemory），先执行迁移（本地或 Vercel 已配好 DATABASE_URL 时）：
   ```bash
   npx prisma migrate deploy
   ```
   若使用 `prisma db push`（无迁移文件）：
   ```bash
   npx prisma db push
   ```
3. 提交并推送代码，触发 Vercel 自动部署：
   ```bash
   cd /Users/akun/Desktop/Ai助理Mac/Ai助理Mac
   git add .
   git status
   git commit -m "feat: 本机执行/助理记忆等后端更新"
   git push
   ```
4. 打开 Vercel 控制台 → 对应项目 → Deployments，等待部署完成（或收到成功通知）。

**方式 2：Vercel CLI 部署**

1. 进入 server 目录：
   ```bash
   cd /Users/akun/Desktop/Ai助理Mac/Ai助理Mac/server
   ```
2. 若需迁移数据库：
   ```bash
   npx prisma migrate deploy
   ```
3. 部署到生产：
   ```bash
   vercel --prod
   ```
4. 按提示选择/确认项目与配置。

**说明**：Vercel 部署时会在云端执行 `prisma generate`；若本次有 schema 变更，需在 Vercel 项目 Settings → Environment Variables 中配置好 `DATABASE_URL`，并在部署后确认是否需在 Vercel 的 Build 或 Deploy 中执行 `prisma migrate deploy`（若 Vercel 未自动跑迁移，可在本地对生产库执行一次 `npx prisma migrate deploy`）。

### 二、Mac 应用重新编译/运行

1. 用 Xcode 打开项目：
   - 打开 `Ai助理Mac.xcodeproj` 或 `Ai助理Mac.xcworkspace`（若用 CocoaPods）。
2. 选择目标为 **Ai助理Mac**（Mac 应用）。
3. 运行 / 打包：
   - **仅运行**：菜单 **Product → Run**，或快捷键 **⌘R**。
   - **打包归档**：**Product → Archive**，完成后在 Organizer 中 **Distribute App**。

无需改服务器地址时，无需修改 `AppServices.swift` 里的 `builtInProductionURL`。

---

## 本次「本机执行」相关更新后的部署清单

- [ ] 后端：已推送 `server/` 代码（含 `localExecution` 与系统提示）并完成 Vercel 部署。
- [ ] 数据库：若之前未跑过 UserMemory 迁移，在 server 目录执行 `npx prisma migrate deploy`（对生产库）。
- [ ] Mac 应用：已在 Xcode 中重新 Run 或 Archive，确保安装的是最新构建。
